<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>The depth-contour (DC) algorithm — dc • flapper</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="The depth-contour (DC) algorithm — dc"><meta property="og:description" content="This function implements the depth-contour (DC) algorithm. This algorithm relates one-dimensional depth time series to a two-dimensional bathymetry surface to determine the extent to which different parts of an area might have (or have not) been used, or effectively represent occupied depths, over time. Given a sequence of depth observations (archival) from a tagged animal and a measurement error parameter (calc_depth_error), at each time step the function determines the cells on a bathymetry raster (bathy) that match the observed depth*. Across all time steps, matches are summed to produce a single map representing the number of occasions when the depth in each cell matched the observed depth."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">flapper</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/flapper_algorithms_faqs.html">`flapper`: practitioner FAQs</a>
    </li>
    <li>
      <a href="../articles/flapper_overview.html">`flapper`: an overview</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/edwardlavender/flapper/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>The depth-contour (DC) algorithm</h1>
    <small class="dont-index">Source: <a href="https://github.com/edwardlavender/flapper/blob/HEAD/R/dc.R" class="external-link"><code>R/dc.R</code></a></small>
    <div class="hidden name"><code>dc.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>This function implements the depth-contour (DC) algorithm. This algorithm relates one-dimensional depth time series to a two-dimensional bathymetry surface to determine the extent to which different parts of an area might have (or have not) been used, or effectively represent occupied depths, over time. Given a sequence of depth observations (<code>archival</code>) from a tagged animal and a measurement error parameter (<code>calc_depth_error</code>), at each time step the function determines the cells on a bathymetry <code><a href="https://rdrr.io/pkg/raster/man/raster.html" class="external-link">raster</a></code> (<code>bathy</code>) that match the observed depth*. Across all time steps, matches are summed to produce a single map representing the number of occasions when the depth in each cell matched the observed depth.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">dc</span><span class="op">(</span></span>
<span>  <span class="va">archival</span>,</span>
<span>  <span class="va">bathy</span>,</span>
<span>  plot_ts <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  calc_depth_error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.5</span>, <span class="fl">2.5</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>  check_availability <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  normalise <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  save_record_spatial <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>  write_record_spatial_for_pf <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  save_args <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  con <span class="op">=</span> <span class="st">""</span>,</span>
<span>  split <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  cl <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  varlist <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>archival</dt>
<dd><p>A dataframe of depth time series (for a single individual). At a minimum, this should contain a column named `depth' with depth observations. Depth should be recorded using absolute values in the same units as the bathymetry (<code>bathy</code>, see below).</p></dd>


<dt>bathy</dt>
<dd><p>A <code><a href="https://rdrr.io/pkg/raster/man/raster.html" class="external-link">raster</a></code> of the bathymetry in an area within which the animal is likely to have been located over the study. Bathymetry values should be recorded as absolute values and in the same units as for depths (see <code>archival</code>).</p></dd>


<dt>plot_ts</dt>
<dd><p>A logical input that defines whether or not to the depth time series before the algorithm is initiated.</p></dd>


<dt>calc_depth_error</dt>
<dd><p>A function that returns the depth errors around a vector of depths. The function should accept vector of depths (from <code>archival$depth</code>) and return a matrix, with one row for each (lower and upper) error and one one column for each depth (if the error varies with depth). For each depth, the two numbers are added to the observed depth to define the range of depths on the bathymetry raster (<code>bathy</code>) that the individual could plausibly have occupied at any time. Since the depth errors are added to the individual's depth, the first number should be negative (i.e., the individual could have been shallower that observed) and the second positive (i.e., the individual could have been deeper than observed). The appropriate form for <code>calc_depth_error</code> depends on the species (pelagic versus demersal/benthic species), the measurement error for the depth observations in <code>archival</code> and bathymetry (<code>bathy</code>) data, as well as the tidal range (m) across the area (over the duration of observations). For example, for a pelagic species, the constant function <code>calc_depth_error = function(...) matrix(c(-2.5, Inf)</code> implies that the individual could have occupied bathymetric cells that are deeper than the observed depth + (-2.5) m and shallower than Inf m (i.e. the individual could have been in any location in which the depth was deeper than the shallow depth limit for the individual). In contrast, for a benthic species, the constant function <code>calc_depth_error = function(...) matrix(c(-2.5, 2.5), nrow = 2)</code> implies that the individual could have occupied bathymetric cells whose depth lies within the interval defined by the observed depth + (-2.5) and + (+2.5) m.</p></dd>


<dt>check_availability</dt>
<dd><p>A logical input that defines whether or not to record explicitly, for each time step, whether or not there were any cells on <code>bathy</code> that matched the observed depth (within the bounds defined by <code>calc_depth_error</code>).</p></dd>


<dt>normalise</dt>
<dd><p>A logical variable that defines whether or not to normalise the map of possible locations at each time step so that their scores sum to one.</p></dd>


<dt>save_record_spatial</dt>
<dd><p>An integer vector that defines the time steps for which to return time step-specific and cumulative maps of the individual's possible locations. <code>save_record_spatial = 0</code> suppresses the return of this information and <code>save_record_spatial = NULL</code> returns this information for all time steps.</p></dd>


<dt>write_record_spatial_for_pf</dt>
<dd><p>(optional) A named list, passed to <code><a href="https://rdrr.io/pkg/terra/man/writeRaster.html" class="external-link">writeRaster</a></code>, to save the <code><a href="https://rdrr.io/pkg/raster/man/raster.html" class="external-link">raster</a></code> of the individual's possible positions at each time step to file. The `filename' argument should be the directory in which to save files. Files are named by archival time steps as `arc_1', `arc_2' and so on.</p></dd>


<dt>save_args</dt>
<dd><p>A logical input that defines whether or not to save the list of function inputs in the returned object.</p></dd>


<dt>verbose</dt>
<dd><p>A logical variable that defines whether or not to print messages to the console or to file to relay function progress. If <code>con = ""</code>, messages are printed to the console; otherwise, they are written to file (see below).</p></dd>


<dt>con</dt>
<dd><p>If <code>verbose = TRUE</code>, <code>con</code> is character string that defines how messages relaying function progress are returned. If <code>con = ""</code>, messages are printed to the console (unless redirected by <code><a href="https://rdrr.io/r/base/sink.html" class="external-link">sink</a></code>). Otherwise, <code>con</code> defines the full pathway to a .txt file (which can be created on-the-fly) into which messages are written to relay function progress.</p></dd>


<dt>split, cl, varlist</dt>
<dd><p>(optional) Parallelisation options. <code>split</code> is an integer which, if supplied, splits the <code>archival</code> dataframe every <code>n</code>th row into chunks†. The algorithm is applied sequentially within each chunk (if applicable) and chunk-wise maps can be summed afterwards to create a single map of space use. The advantage of this approach is that chunks can be analysed in parallel, via <code>cl</code> and <code>varlist</code>, while memory use is minimised. <code>cl</code> is (a) a cluster object from <code><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></code> or (b) an integer that defines the number of child processes. <code>varlist</code> is a character vector of variables for export (see <code><a href="cl.html">cl_export</a></code>). Exported variables must be located in the global environment. If a cluster is supplied, the connection to the cluster is closed within the function (see <code><a href="cl.html">cl_stop</a></code>). For further information, see <code><a href="cl.html">cl_lapply</a></code> and <code><a href="flapper-tips-parallel.html">flapper-tips-parallel</a></code>.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p>The function returns an <code><a href="acdc_archive-class.html">acdc_archive-class</a></code> object. If a connection to write files has also been specified, messages are also written to file relaying function progress.</p>
    </div>
    <div id="details">
    <h2>Details</h2>
    <p>This algorithm can be applied to both pelagic species (which must be in an area where the depth is at least as deep as the observed depth) and benthic/demersal species (which must be in an area relatively close in depth to the observed depth). However, the results are likely to be much more precise for benthic species because depth observations for benthic animals are typically more informative about a tagged animal's possible location(s) than for pelagic species.</p>
<p>*Location probability could be weighted by the proximity between the observed depth and the depths of cells within the range defined by the observed depth and the measurement error (i.e., <code>archival$depth[1] + calc_depth_error(archival$depth[1])[1], archival$depth[1] + calc_depth_error(archival$depth[1])[2]</code>), but this is not currently implemented.</p>
<p>†Under the default options (<code>split = NULL</code>), the function starts with a blank map of the area and iterates over each time step, adding the `possible positions' of the individual to the map at each step. By continuously updating a single map, this approach is slow but minimises memory requirements. An alternative approach is to split the time series into chunks, implement an iterative approach within each chunk, and then join the maps for each chunk. This is implemented by <code>split</code> (plus <code><a href="acdc_simplify.html">acdc_simplify</a></code>).</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p><code><a href="acdc_simplify.html">acdc_simplify</a></code> simplifies the outputs of the algorithm. <code><a href="acdc_plot_trace.html">acdc_plot_trace</a></code>, <code><a href="acdc_plot_record.html">acdc_plot_record</a></code> and <code><a href="acdc_animate_record.html">acdc_animate_record</a></code> provide plotting routines. <code><a href="dcq.html">dcq</a></code> implements a faster version of this algorithm termed the `quick depth-contour' (DCQ) algorithm. Rather than considering the depth interval that the individual could have occupied at each time step, the DCQ algorithm considers a sequence of depth bins (e.g., 10 m bins), isolates these on the bathymetry <code><a href="https://rdrr.io/pkg/raster/man/raster.html" class="external-link">raster</a></code> (<code>bathy</code>) and counts the number of matches in each cell. The DCPF algorithm (see <code><a href="pf.html">pf</a></code>) extends the DC algorithm via particle filtering to reconstruct possible movement paths over <code>bathy</code>. The ACDC algorithm (see <code><a href="acdc.html">acdc</a></code>) extends the depth-contour algorithm by integrating information from acoustic detections of individuals at each time step to restrict the locations in which depth contours are identified.</p></div>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Edward Lavender</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co">#### Define depth time series for examples</span></span></span>
<span class="r-in"><span><span class="co"># We will use a sample depth time series for one individual</span></span></span>
<span class="r-in"><span><span class="co"># We will select a small sample of observations for example speed</span></span></span>
<span class="r-in"><span><span class="va">depth</span> <span class="op">&lt;-</span> <span class="va">dat_archival</span><span class="op">[</span><span class="va">dat_archival</span><span class="op">$</span><span class="va">individual_id</span> <span class="op">==</span> <span class="fl">25</span>, <span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Example (1): Implement algorithm with default options</span></span></span>
<span class="r-in"><span><span class="co">## Implement algorithm</span></span></span>
<span class="r-in"><span><span class="va">out_dc</span> <span class="op">&lt;-</span> <span class="fu">dc</span><span class="op">(</span>archival <span class="op">=</span> <span class="va">depth</span>, bathy <span class="op">=</span> <span class="va">dat_gebco</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> flapper::dc() called (@ 2023-02-19 14:53:45)... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Setting up function... </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 'calc_depth_error' function taken to be independent of depth.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Implementing calc_depth_error()... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Plotting movement time series (for each chunk)... </span>
<span class="r-plt img"><img src="dc-1.png" alt="" width="700" height="433"></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Implementing algorithm over time steps... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... flapper::dc() call completed (@ 2023-02-19 14:53:47) after ~0.02 minutes. </span>
<span class="r-in"><span><span class="co">## dc() returns a named list that is an 'acdc_archive' class object</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">out_dc</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             Length Class      Mode</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> archive      1     -none-     list</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ts_by_chunk  1     -none-     list</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> time         4     data.frame list</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> args        14     -none-     list</span>
<span class="r-in"><span><span class="co"># ... archive elements contain the key information from the algorithm</span></span></span>
<span class="r-in"><span><span class="co"># ... ts_by_chunk contains the time series for each chunk</span></span></span>
<span class="r-in"><span><span class="co"># ... time contains a dataframe of the algorithm's progression</span></span></span>
<span class="r-in"><span><span class="co"># ... args contains a list of user inputs</span></span></span>
<span class="r-in"><span><span class="co">## Simplify outputs via acdc_simplify()</span></span></span>
<span class="r-in"><span><span class="va">dc_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="acdc_simplify.html">acdc_simplify</a></span><span class="op">(</span><span class="va">out_dc</span>, type <span class="op">=</span> <span class="st">"dc"</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> acdc_simplify() implemented for type = 'dc'.</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">dc_summary</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          Length Class       Mode   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> map      4218   RasterLayer S4     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> record    100   -none-      list   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> time        4   data.frame  list   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> args       14   -none-      list   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> chunks      0   -none-      NULL   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> simplify    1   -none-      logical</span>
<span class="r-in"><span><span class="co">## Examine time-specific maps via acdc_plot_record()</span></span></span>
<span class="r-in"><span><span class="fu"><a href="acdc_plot_record.html">acdc_plot_record</a></span><span class="op">(</span><span class="va">dc_summary</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> flapper::acdc_plot_record() called... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Checking function inputs... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Defining data for background plot... </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> add_containers = NULL implemented: 'record' does not contain containers.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Setting plotting window... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Making plots for each time step ... </span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Nothing to summarize if you provide a single RasterLayer; see cellStats</span>
<span class="r-plt img"><img src="dc-2.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="co">## Examine overall map via a raster* plotting function</span></span></span>
<span class="r-in"><span><span class="co"># Each cell shows expected proportion of time steps spent in each cell</span></span></span>
<span class="r-in"><span><span class="fu">prettyGraphics</span><span class="fu">::</span><span class="fu"><a href="https://edwardlavender.github.io/prettyGraphics/reference/pretty_map.html" class="external-link">pretty_map</a></span><span class="op">(</span>add_rasters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dc_summary</span><span class="op">$</span><span class="va">map</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                           add_polys <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dat_coast</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> prettyGraphics::pretty_map() CRS taken as: '+proj=utm +zone=29 +datum=WGS84 +units=m +no_defs'.</span>
<span class="r-plt img"><img src="dc-3.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="co"># Convert counts on map to percentages</span></span></span>
<span class="r-in"><span><span class="fu">prettyGraphics</span><span class="fu">::</span><span class="fu"><a href="https://edwardlavender.github.io/prettyGraphics/reference/pretty_map.html" class="external-link">pretty_map</a></span><span class="op">(</span>add_rasters <span class="op">=</span></span></span>
<span class="r-in"><span>                             <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dc_summary</span><span class="op">$</span><span class="va">map</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">depth</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>,</span></span>
<span class="r-in"><span>                                  zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                           add_polys <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dat_coast</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> prettyGraphics::pretty_map() CRS taken as: '+proj=utm +zone=29 +datum=WGS84 +units=m +no_defs'.</span>
<span class="r-plt img"><img src="dc-4.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="co"># Check for occasions when the individual's depth was not consistent</span></span></span>
<span class="r-in"><span><span class="co"># ... with the depth data for the area and the depth error e.g., possibly</span></span></span>
<span class="r-in"><span><span class="co"># ... due to movement beyond this area:</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">dc_summary</span><span class="op">$</span><span class="va">record</span>, <span class="kw">function</span><span class="op">(</span><span class="va">elm</span><span class="op">)</span> <span class="va">elm</span><span class="op">$</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">availability</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] FALSE</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Example (2): Implement depth error functions that depend on depth</span></span></span>
<span class="r-in"><span><span class="co">## Here, we will define a calc_depth_error function that depends on:</span></span></span>
<span class="r-in"><span><span class="co"># ... tag error</span></span></span>
<span class="r-in"><span><span class="co"># ... tidal range</span></span></span>
<span class="r-in"><span><span class="co"># ... a depth-dependent bathymetry error</span></span></span>
<span class="r-in"><span><span class="va">cde</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">depth</span><span class="op">)</span><span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">e</span> <span class="op">&lt;-</span> <span class="fl">4.77</span> <span class="op">+</span> <span class="fl">2.5</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">0.5</span> <span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.013</span> <span class="op">*</span> <span class="va">depth</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">e</span>, <span class="va">e</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span><span class="co"># Vectorise function over depths (essential)</span></span></span>
<span class="r-in"><span><span class="va">cde</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Vectorize.html" class="external-link">Vectorize</a></span><span class="op">(</span><span class="va">cde</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">## Implement algorithm with  depth-dependent error</span></span></span>
<span class="r-in"><span><span class="va">out_dc</span> <span class="op">&lt;-</span> <span class="fu">dc</span><span class="op">(</span>archival <span class="op">=</span> <span class="va">depth</span>, bathy <span class="op">=</span> <span class="va">dat_gebco</span>, calc_depth_error <span class="op">=</span> <span class="va">cde</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> flapper::dc() called (@ 2023-02-19 14:53:47)... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Setting up function... </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 'calc_depth_error' taken to depend on depth.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Implementing calc_depth_error()... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Plotting movement time series (for each chunk)... </span>
<span class="r-plt img"><img src="dc-5.png" alt="" width="700" height="433"></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Implementing algorithm over time steps... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... flapper::dc() call completed (@ 2023-02-19 14:53:48) after ~0.02 minutes. </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Example (3): Write timestep-specific maps of allowed positions to file</span></span></span>
<span class="r-in"><span><span class="va">out_dc</span> <span class="op">&lt;-</span> <span class="fu">dc</span><span class="op">(</span>archival <span class="op">=</span> <span class="va">depth</span>, bathy <span class="op">=</span> <span class="va">dat_gebco</span>,</span></span>
<span class="r-in"><span>             write_record_spatial_for_pf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> flapper::dc() called (@ 2023-02-19 14:53:48)... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Setting up function... </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 'calc_depth_error' function taken to be independent of depth.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> '/' added to the directory inputted to the argument 'write_record_spatial_for_pf$filename' ('/var/folders/lx/dhz6yx2n2b7bg93hwz8t97zr0000gq/T//RtmpUnZ226').</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Implementing calc_depth_error()... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Plotting movement time series (for each chunk)... </span>
<span class="r-plt img"><img src="dc-6.png" alt="" width="700" height="433"></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Implementing algorithm over time steps... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... flapper::dc() call completed (@ 2023-02-19 14:53:51) after ~0.05 minutes. </span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [1] "1.png"                    "2.png"                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [3] "25"                       "28"                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [5] "35"                       "ACDC_algorithm_demo.html"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [7] "acdc_log.txt"             "acdc_trace"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [9] "arc_1.grd"                "arc_1.gri"               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [11] "arc_10.grd"               "arc_10.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [13] "arc_100.grd"              "arc_100.gri"             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [15] "arc_11.grd"               "arc_11.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [17] "arc_12.grd"               "arc_12.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [19] "arc_13.grd"               "arc_13.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [21] "arc_14.grd"               "arc_14.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [23] "arc_15.grd"               "arc_15.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [25] "arc_16.grd"               "arc_16.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [27] "arc_17.grd"               "arc_17.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [29] "arc_18.grd"               "arc_18.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [31] "arc_19.grd"               "arc_19.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [33] "arc_2.grd"                "arc_2.gri"               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [35] "arc_20.grd"               "arc_20.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [37] "arc_21.grd"               "arc_21.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [39] "arc_22.grd"               "arc_22.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [41] "arc_23.grd"               "arc_23.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [43] "arc_24.grd"               "arc_24.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [45] "arc_25.grd"               "arc_25.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [47] "arc_26.grd"               "arc_26.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [49] "arc_27.grd"               "arc_27.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [51] "arc_28.grd"               "arc_28.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [53] "arc_29.grd"               "arc_29.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [55] "arc_3.grd"                "arc_3.gri"               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [57] "arc_30.grd"               "arc_30.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [59] "arc_31.grd"               "arc_31.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [61] "arc_32.grd"               "arc_32.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [63] "arc_33.grd"               "arc_33.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [65] "arc_34.grd"               "arc_34.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [67] "arc_35.grd"               "arc_35.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [69] "arc_36.grd"               "arc_36.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [71] "arc_37.grd"               "arc_37.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [73] "arc_38.grd"               "arc_38.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [75] "arc_39.grd"               "arc_39.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [77] "arc_4.grd"                "arc_4.gri"               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [79] "arc_40.grd"               "arc_40.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [81] "arc_41.grd"               "arc_41.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [83] "arc_42.grd"               "arc_42.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [85] "arc_43.grd"               "arc_43.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [87] "arc_44.grd"               "arc_44.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [89] "arc_45.grd"               "arc_45.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [91] "arc_46.grd"               "arc_46.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [93] "arc_47.grd"               "arc_47.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [95] "arc_48.grd"               "arc_48.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [97] "arc_49.grd"               "arc_49.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [99] "arc_5.grd"                "arc_5.gri"               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [101] "arc_50.grd"               "arc_50.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [103] "arc_51.grd"               "arc_51.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [105] "arc_52.grd"               "arc_52.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [107] "arc_53.grd"               "arc_53.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [109] "arc_54.grd"               "arc_54.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [111] "arc_55.grd"               "arc_55.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [113] "arc_56.grd"               "arc_56.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [115] "arc_57.grd"               "arc_57.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [117] "arc_58.grd"               "arc_58.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [119] "arc_59.grd"               "arc_59.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [121] "arc_6.grd"                "arc_6.gri"               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [123] "arc_60.grd"               "arc_60.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [125] "arc_61.grd"               "arc_61.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [127] "arc_62.grd"               "arc_62.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [129] "arc_63.grd"               "arc_63.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [131] "arc_64.grd"               "arc_64.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [133] "arc_65.grd"               "arc_65.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [135] "arc_66.grd"               "arc_66.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [137] "arc_67.grd"               "arc_67.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [139] "arc_68.grd"               "arc_68.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [141] "arc_69.grd"               "arc_69.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [143] "arc_7.grd"                "arc_7.gri"               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [145] "arc_70.grd"               "arc_70.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [147] "arc_71.grd"               "arc_71.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [149] "arc_72.grd"               "arc_72.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [151] "arc_73.grd"               "arc_73.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [153] "arc_74.grd"               "arc_74.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [155] "arc_75.grd"               "arc_75.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [157] "arc_76.grd"               "arc_76.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [159] "arc_77.grd"               "arc_77.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [161] "arc_78.grd"               "arc_78.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [163] "arc_79.grd"               "arc_79.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [165] "arc_8.grd"                "arc_8.gri"               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [167] "arc_80.grd"               "arc_80.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [169] "arc_81.grd"               "arc_81.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [171] "arc_82.grd"               "arc_82.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [173] "arc_83.grd"               "arc_83.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [175] "arc_84.grd"               "arc_84.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [177] "arc_85.grd"               "arc_85.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [179] "arc_86.grd"               "arc_86.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [181] "arc_87.grd"               "arc_87.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [183] "arc_88.grd"               "arc_88.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [185] "arc_89.grd"               "arc_89.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [187] "arc_9.grd"                "arc_9.gri"               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [189] "arc_90.grd"               "arc_90.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [191] "arc_91.grd"               "arc_91.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [193] "arc_92.grd"               "arc_92.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [195] "arc_93.grd"               "arc_93.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [197] "arc_94.grd"               "arc_94.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [199] "arc_95.grd"               "arc_95.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [201] "arc_96.grd"               "arc_96.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [203] "arc_97.grd"               "arc_97.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [205] "arc_98.grd"               "arc_98.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [207] "arc_99.grd"               "arc_99.gri"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [209] "css"                      "dot_acdc_log_1.txt"      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [211] "dot_acdc_log_2.txt"       "dot_acdc_log_3.txt"      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [213] "dot_acdc_log_4.txt"       "dot_acdc_log_5.txt"      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [215] "downlit"                  "file77b31494a445"        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [217] "file77b3284fa5e6"         "file77b330cf712d"        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [219] "file77b331894d7a"         "file77b3353096a0"        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [221] "file77b33e14800b"         "file77b359d252e"         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [223] "file77b38f0fda8"          "images"                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [225] "js"                      </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Example (4): Implement the algorithm in parallel</span></span></span>
<span class="r-in"><span><span class="co">## Trial different options for 'split' and compare speed</span></span></span>
<span class="r-in"><span><span class="co"># Approach (1)</span></span></span>
<span class="r-in"><span><span class="va">at1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterEvalQ</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>, <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster" class="external-link">raster</a></span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [[1]]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "raster"    "sp"        "stats"     "graphics"  "grDevices" "utils"    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [7] "datasets"  "methods"   "base"     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [[2]]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "raster"    "sp"        "stats"     "graphics"  "grDevices" "utils"    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [7] "datasets"  "methods"   "base"     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span><span class="va">out_dc</span> <span class="op">&lt;-</span> <span class="fu">dc</span><span class="op">(</span>archival <span class="op">=</span> <span class="va">depth</span>,</span></span>
<span class="r-in"><span>             bathy <span class="op">=</span> <span class="va">dat_gebco</span>,</span></span>
<span class="r-in"><span>             plot_ts <span class="op">=</span> <span class="cn">FALSE</span>,</span></span>
<span class="r-in"><span>             split <span class="op">=</span> <span class="fl">1</span>,</span></span>
<span class="r-in"><span>             cl <span class="op">=</span> <span class="va">cl</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> flapper::dc() called (@ 2023-02-19 14:53:57)... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Setting up function... </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 'calc_depth_error' function taken to be independent of depth.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Implementing calc_depth_error()... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Implementing algorithm over chunks... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... flapper::dc() call completed (@ 2023-02-19 14:53:58) after ~0.02 minutes. </span>
<span class="r-in"><span><span class="va">at2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Approach (2)</span></span></span>
<span class="r-in"><span><span class="va">bt1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterEvalQ</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>, <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster" class="external-link">raster</a></span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [[1]]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "raster"    "sp"        "stats"     "graphics"  "grDevices" "utils"    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [7] "datasets"  "methods"   "base"     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [[2]]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "raster"    "sp"        "stats"     "graphics"  "grDevices" "utils"    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [7] "datasets"  "methods"   "base"     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span><span class="va">out_dc</span> <span class="op">&lt;-</span> <span class="fu">dc</span><span class="op">(</span>archival <span class="op">=</span> <span class="va">depth</span>,</span></span>
<span class="r-in"><span>             bathy <span class="op">=</span> <span class="va">dat_gebco</span>,</span></span>
<span class="r-in"><span>             plot_ts <span class="op">=</span> <span class="cn">FALSE</span>,</span></span>
<span class="r-in"><span>             split <span class="op">=</span> <span class="fl">5</span>,</span></span>
<span class="r-in"><span>             cl <span class="op">=</span> <span class="va">cl</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> flapper::dc() called (@ 2023-02-19 14:54:04)... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Setting up function... </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 'calc_depth_error' function taken to be independent of depth.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Implementing calc_depth_error()... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Implementing algorithm over chunks... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... flapper::dc() call completed (@ 2023-02-19 14:54:06) after ~0.03 minutes. </span>
<span class="r-in"><span><span class="va">bt2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Compare timings</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="va">at2</span>, <span class="va">at1</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Time difference of 6.828754 secs</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="va">bt2</span>, <span class="va">bt1</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Time difference of 7.341262 secs</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Example (5): Write messages to file via con</span></span></span>
<span class="r-in"><span><span class="va">out_dc</span> <span class="op">&lt;-</span> <span class="fu">dc</span><span class="op">(</span>archival <span class="op">=</span> <span class="va">depth</span>, bathy <span class="op">=</span> <span class="va">dat_gebco</span>,</span></span>
<span class="r-in"><span>             con <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"/dc_log.txt"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> /var/folders/lx/dhz6yx2n2b7bg93hwz8t97zr0000gq/T//RtmpUnZ226/dc_log.txt does not exist: attempting to write file in specified directory...</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> ... Blank file successfully written to file.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 'calc_depth_error' function taken to be independent of depth.</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"/dc_log.txt"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "flapper::dc() called (@ 2023-02-19 14:54:06)... "                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2] "... Setting up function... "                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3] "... Implementing calc_depth_error()... "                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [4] "... Plotting movement time series (for each chunk)... "                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [5] "... Implementing algorithm over time steps... "                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [6] "... flapper::dc() call completed (@ 2023-02-19 14:54:07) after ~0.03 minutes. "</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Example (6) Compare an automated vs. manual implementation of DC</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## (A) Compare step-wise results for randomly select time steps</span></span></span>
<span class="r-in"><span><span class="co"># Implement algorithm (using default calc_depth_error)</span></span></span>
<span class="r-in"><span><span class="va">out_dc</span> <span class="op">&lt;-</span> <span class="fu">dc</span><span class="op">(</span>archival <span class="op">=</span> <span class="va">depth</span>,</span></span>
<span class="r-in"><span>             bathy <span class="op">=</span> <span class="va">dat_gebco</span>,</span></span>
<span class="r-in"><span>             save_record_spatial <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> flapper::dc() called (@ 2023-02-19 14:54:07)... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Setting up function... </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 'calc_depth_error' function taken to be independent of depth.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Implementing calc_depth_error()... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Plotting movement time series (for each chunk)... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Implementing algorithm over time steps... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... flapper::dc() call completed (@ 2023-02-19 14:54:09) after ~0.03 minutes. </span>
<span class="r-in"><span><span class="co"># Compare results for randomly selected time steps to manual implementation</span></span></span>
<span class="r-in"><span><span class="co"># ... with the same simple calc_depth_error model</span></span></span>
<span class="r-in"><span><span class="va">pp</span> <span class="op">&lt;-</span> <span class="fu">graphics</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">depth</span><span class="op">)</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="co"># Extract map created via dc()</span></span></span>
<span class="r-in"><span>  <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">out_dc</span><span class="op">$</span><span class="va">archive</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">record</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">spatial</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">map_timestep</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="co"># Compare to manual creation of map</span></span></span>
<span class="r-in"><span>  <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dat_gebco</span> <span class="op">&gt;=</span> <span class="va">depth</span><span class="op">$</span><span class="va">depth</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="fl">2.5</span> <span class="op">&amp;</span> <span class="va">dat_gebco</span> <span class="op">&lt;=</span> <span class="va">depth</span><span class="op">$</span><span class="va">depth</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2.5</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-plt img"><img src="dc-7.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="fu">graphics</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">pp</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## (B) Compare the chunk-wise results and manual implementation</span></span></span>
<span class="r-in"><span><span class="co"># Implement algorithm chunk-wise</span></span></span>
<span class="r-in"><span><span class="va">out_dc</span> <span class="op">&lt;-</span> <span class="fu">dc</span><span class="op">(</span>archival <span class="op">=</span> <span class="va">depth</span>,</span></span>
<span class="r-in"><span>             bathy <span class="op">=</span> <span class="va">dat_gebco</span>,</span></span>
<span class="r-in"><span>             save_record_spatial <span class="op">=</span> <span class="cn">NULL</span>,</span></span>
<span class="r-in"><span>             split <span class="op">=</span> <span class="fl">10L</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> flapper::dc() called (@ 2023-02-19 14:54:10)... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Setting up function... </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 'calc_depth_error' function taken to be independent of depth.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Implementing calc_depth_error()... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Plotting movement time series (for each chunk)... </span>
<span class="r-plt img"><img src="dc-8.png" alt="" width="700" height="433"></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Implementing algorithm over chunks... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... flapper::dc() call completed (@ 2023-02-19 14:54:11) after ~0.03 minutes. </span>
<span class="r-in"><span><span class="co"># Get overall map via acdc_simplify()</span></span></span>
<span class="r-in"><span><span class="va">map_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="acdc_simplify.html">acdc_simplify</a></span><span class="op">(</span><span class="va">out_dc</span>, type <span class="op">=</span> <span class="st">"dc"</span>, mask <span class="op">=</span> <span class="va">dat_gebco</span><span class="op">)</span><span class="op">$</span><span class="va">map</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> acdc_simplify() implemented for type = 'dc'.</span>
<span class="r-in"><span><span class="co"># Get overall map via a simple custom approach</span></span></span>
<span class="r-in"><span><span class="va">map_2</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/setValues.html" class="external-link">setValues</a></span><span class="op">(</span><span class="va">dat_gebco</span>, <span class="fl">0</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">depth</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">map_2</span> <span class="op">&lt;-</span> <span class="va">map_2</span> <span class="op">+</span> <span class="op">(</span><span class="va">dat_gebco</span> <span class="op">&gt;=</span> <span class="va">depth</span><span class="op">$</span><span class="va">depth</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="fl">2.5</span> <span class="op">&amp;</span> <span class="va">dat_gebco</span> <span class="op">&lt;=</span> <span class="va">depth</span><span class="op">$</span><span class="va">depth</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2.5</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="va">map_2</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="va">map_2</span>, <span class="va">dat_gebco</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Show that the two overall maps are identical</span></span></span>
<span class="r-in"><span><span class="va">pp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">map_1</span>, main <span class="op">=</span> <span class="st">"Automated"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">map_2</span>, main <span class="op">=</span> <span class="st">"Custom"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">map_1</span> <span class="op">-</span> <span class="va">map_2</span>, main <span class="op">=</span> <span class="st">"Difference"</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="dc-9.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">pp</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Edward Lavender.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

